#!/usr/bin/env bash
# bin/test <build-dir> <env-dir>

### Configure environment
set -o errexit    # always exit on error

### Configure directories
BUILD_DIR=${1:-}
ENV_DIR=${2:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

source $BP_DIR/lib/utils
export_env_dir "$ENV_DIR"

cd $BUILD_DIR

if [ -z ${PROJECT_FILE:-} ]; then
	PROJECT_FILE=$(find ${BUILD_DIR} -maxdepth 5 -name *.csproj -exec grep -l -H 'Microsoft.NET.Test.Sdk' {} \;)
fi

if [ -z ${PROJECT_NAME:-} ]; then
	PROJECT_NAME=$(basename ${PROJECT_FILE%.*})
fi

echo "test ${PROJECT_FILE}"
echo "path ${DOTNET_SDK_LOCATION}"
export PATH="${DOTNET_SDK_LOCATION}:${PATH}"
dotnet test $PROJECT_FILE -v q --no-build --no-restore --output ${BUILD_DIR}/test_output
